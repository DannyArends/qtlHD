#! /usr/bin/rake
#
# Rake file for building qtlHD binaries, libraries and unit tests. 
#
# Examples:
#
#   rake                 # default build and test
#   rake -T              # list all defined rake tasks
#   rake build          
#   rake run
#   rake test
#   rake csv2xgap        # build utility
#   rake read_csv        # CSV unit tests
#   rake read_csvr       # CSVr unit tests

PROG = 'read_csv'  # this will change 

core_dfiles = Dir.glob("./qtl/core/*.d")

file "read_csv" => core_dfiles do
  sh "dmd -unittest -ofread_csv #{core_dfiles.join(" ")} qtl/plugins/input/read_csv.d test/main.d"
end

file "read_csvr" => core_dfiles do
  sh "dmd -unittest -ofread_csvr #{core_dfiles.join(" ")} qtl/plugins/input/read_csvr.d qtl/plugins/input/read_csv.d test/main.d"
end

file "write_xgapbin" => core_dfiles do
  sh "dmd -unittest -ofwrite_xgapbin #{core_dfiles.join(" ")} qtl/plugins/output/write_xgapbin.d qtl/plugins/input/read_csv.d qtl/plugins/input/read_csvr.d test/main.d"
end

file "csv2xgap" => core_dfiles << "qtl/util/csv2xgap.d" do
  sh "dmd -ofcsv2xgap #{core_dfiles.join(" ")} qtl/plugins/output/write_xgapbin.d qtl/plugins/input/read_csv.d qtl/plugins/input/read_csvr.d"
end

# ---- Standard tasks

desc "Default builds and tests #{PROG}"
task :default => [:build, :test]

desc "Build default binaries"
task :build => [PROG, :csv2xgap ]

desc "Run #{PROG}"
task :run => [PROG] do
  print "Running #{PROG}\n"
  sh "./#{PROG}" 
end

desc "Test #{PROG}"
task :test => [PROG] do
  print "Testing #{PROG}\n"
  sh "./#{PROG}" 
end

# ---- Utilities


# ---- Unit tests

desc "Test CSVr"
task :test_csvr => [ 'read_csvr' ] do 
  sh "./read_csvr" 
end
